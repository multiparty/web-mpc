<!doctype html>
<html>
<head>
  <title>Boston Women's Workforce Council</title>

  <script type="text/javascript" src="../shared/jquery-3.1.1.min.js"></script>
  <script type="text/javascript" src="../shared/underscore.js"></script>
  <script type="text/javascript" src="../shared/handsontable-pro/dist/handsontable.full.js"></script>
  <script type="text/javascript" src="../shared/forge.min.js"></script>
  <script type="text/javascript" src="../shared/mpc.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
          integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
          crossorigin="anonymous"></script>
  <script type="text/javascript" src="style/alertify/alertify.js"></script>
  <script type="text/javascript" src="style/alertify/alertify-defaults.js"></script>
  <script type="text/javascript" src="style/qtip/jquery.qtip.min.js"></script>
  <script type="text/javascript" src="script/spin.min.js"></script>
  <script type="text/javascript" src="script/ladda.min.js"></script>
  <script type="text/javascript" src="../shared/sail_hot.js"></script>
  <script type="text/javascript" src="script/client.js"></script>
  <script type="text/javascript" src="script/xlsx.full.min.js"></script>
  <script src="script/path.js"></script>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
        integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="style/qtip/jquery.qtip.min.css">
  <link rel="stylesheet" type="text/css" href="../shared/handsontable-pro/dist/handsontable.full.css">
  <link rel="stylesheet" type="text/css" href="style/alertify/css/alertify.css">
  <link rel="stylesheet" type="text/css" href="style/alertify/css/themes/alertify-bootstrap.css">
  <link rel="stylesheet" href="style/ladda-themeless.min.css">
  <link rel="stylesheet" href="style/style.css">
</head>
<body>
<header>
  <div class="container">
    <h1>Boston Women's Workforce Council<br/>
      <small>100% Talent Data Submission</small>
    </h1>
    <div id="logos">
      <img src="../shared/bwwc.png" width="130" alt="BWWC Logo"/>
      <img src="../shared/bu.gif" alt="BU Logo"/>
    </div>
  </div>
</header>
<div id="shadow" class="ss-style-multitriangles"></div>
<main id="content" class="container">
  <section id="session-area" class="card">
    <h2 class="text-center">Submit your data</h2>
    <p class="text-center">Please make sure your session key and participation code match the ones provided in the email
      sent to you by the BWWC. Drag and drop your completed template file to encrypt and include your submission in the
      aggregate data.</p>
    <hr/>
    <div class="row">
      <div class="col-md-6">
        <form>
          <div class="form-group">
            <label class="control-label" for="session">Session key</label>
            <input type="text" id="session" class="form-control" placeholder="Session key" pattern="^[a-zA-Z0-9]{26}$"
                   autocomplete="off" required/>
            <span id="session-success" class="success-icon glyphicon glyphicon-ok form-control-feedback hidden"
                  aria-hidden="true"></span>
            <span id="session-fail" class="fail-icon glyphicon glyphicon-remove form-control-feedback hidden"
                  aria-hidden="true"></span>
            <span id="session-fail-help"
                  class="fail-help help-block hidden">Please input the 26-character session key.</span>
          </div>
          <div class="form-group">
            <label class="control-label" for="participation-code">Participation code</label>
            <input type="text" id="participation-code" class="form-control" placeholder="Participation code"
                   pattern="^[a-zA-Z0-9]{26}$"
                   autocomplete="off" required>
            <span id="participation-code-success"
                  class="success-icon glyphicon glyphicon-ok form-control-feedback hidden"
                  aria-hidden="true"></span>
            <span id="participation-code-fail" class="fail-icon glyphicon glyphicon-remove form-control-feedback hidden"
                  aria-hidden="true"></span>
            <span id="participation-code-fail-help"
                  class="fail-help help-block hidden">Please input the 26-character participation code.</span>
          </div>
        </form>
      </div>
      <div class="col-md-6">
        <div id="drop-area">
          Drag and drop your completed template file
          <br/>
          <p>&mdash;or&mdash;</p><br/>
          <button id="choose-file-button" class="btn btn-primary">Choose file</button>
        </div>
        <input type="file" id="choose-file" accept=".xlsx,.xls">
      </div>
    </div>
  </section>

  <section id="instructions" class="card">
    <h2 class="text-center">Didn't use the template?</h2>
    <p class="text-center">Enter in data manually by clicking on this button and filling out
      the tables that appear.</p>
    <span id="expand-table-button" class="arrow-down"></span>

    <div id="tables-area">
      <hr/>
      <h3>Entered Data</h3>
      <div>Any red cells indicate an error - click on the cell to see the error message.</div>
      <div>
        <h4 id="number-employees-hot-name"></h4>
        <div id="number-employees-hot"></div>
      </div>

      <div>
        <h4 id="compensation-hot-name"></h4>
        <div id="compensation-hot"></div>
      </div>

      <div>
        <h4 id="performance-pay-hot-name"></h4>
        <div id="performance-pay-hot"></div>
      </div>

      <div>
        <h4 id="service-length-hot-name"></h4>
        <div id="service-length-hot"></div>
      </div>
    </div>
  </section>

  <section id="additional-questions" class="card">
    <h2 class="text-center">Additional Questions</h2>
    <p class="text-center">
      We have included these questions to get instant feedback as to how this process went in order to improve the
      process in future years. Please know that the answers to these questions will be anonymous, and they will be
      considered separately from the encrypted and aggregated data above.
    </p>
    <hr/>
    <div id="questions">
      <form>
        <p class="question-text">Does your company hold events to celebrate diversity and inclusion?</p>
        <div class="radio">
          <label><input type="radio" name="optradio" value="Yes">Yes</label>
        </div>
        <div class="radio">
          <label><input type="radio" name="optradio" value="No">No</label>
        </div>
        <div class="radio">
          <label>
            <input type="radio" name="optradio" value="NA" checked="checked">
            Do not wish to answer
          </label>
        </div>
      </form>
      <hr class="short"/>
      <form>
        <p class="question-text">Does your company provide diversity and inclusion education or training for managers,
          staff or both?</p>
        <div class="radio">
          <label><input type="radio" name="optradio" value="Yes">Yes</label>
        </div>
        <div class="radio">
          <label><input type="radio" name="optradio" value="No">No</label>
        </div>
        <div class="radio">
          <label>
            <input type="radio" name="optradio" value="NA" checked="checked">
            Do not wish to answer
          </label>
        </div>
      </form>
      <hr class="short"/>
      <form>
        <p class="question-text">Does your management team meet to discuss your organization's diverse workforce or
          workplace culture?</p>
        <div class="radio">
          <label><input type="radio" name="optradio" value="Yes">Yes</label>
        </div>
        <div class="radio">
          <label><input type="radio" name="optradio" value="No">No</label>
        </div>
        <div class="radio">
          <label>
            <input type="radio" name="optradio" value="NA" checked="checked">
            Do not wish to answer
          </label>
        </div>
      </form>
      <hr class="short"/>
      <form>
        <p class="question-text">Does your CEO engage in or lead discussions on diversity and inclusion with your
          management team or with other business executives?</p>
        <div class="radio">
          <label><input type="radio" name="optradio" value="Yes">Yes</label>
        </div>
        <div class="radio">
          <label><input type="radio" name="optradio" value="No">No</label>
        </div>
        <div class="radio">
          <label>
            <input type="radio" name="optradio" value="NA" checked="checked">
            Do not wish to answer
          </label>
        </div>
      </form>
    </div>
  </section>

  <section class="card">
    <h2 class="text-center">Submit your data</h2>
    <p class="text-center">
      Instructions on how to fill out this section.
    </p>
    <hr/>
    <!-- Submit panel is split up into two halves -->
    <!-- Left Half -->
    <div class="row">
      <div class="col-md-6">
        <h4 id="totals-hot-name"></h4>
        <div id="totals-hot"></div>
        <form>
          <div class="checkbox">
            <label>
              <input type="checkbox" id="verify" name="verify">All information is verified and correct
            </label>
          </div>
        </form>
      </div>
      <div class="col-md-6">
        <h4>Errors</h4>
        <ul class="errors">
          <li>No Errors!</li>
        </ul>
        <h4>Submission history</h4>
        <ul class="previous_submits">
        </ul>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <button type="submit" id="submit" class="btn btn-primary ladda-button btn-lg btn-block">Submit</button>
      </div>
    </div>
  </section>
  <br/>
  <script type="text/javascript" src="script/drop_sheet.js"></script>

  <script type="text/javascript">
    $(document).ready(function () {

      var $session = $('#session');
      var $participationCode = $('#participation-code');

      /**
       * Validate the session and participation code input fields.
       */
      var validateSessionInput = function (e) {
        if (!e.target.validity) {
          return false;
        }

        // Validate immediately once blur has been fired
        $('#session, #participation-code')
          .off('input')
          .on('input', validateSessionInput);

        var $parent = $(e.target).parent();
        if (e.target.validity.valid) {

          $parent.removeClass('has-error').addClass('has-success has-feedback');
          $parent.find('.success-icon').removeClass('hidden').addClass('show');
          $parent.find('.fail-icon').removeClass('show').addClass('hidden');
          $parent.find('.fail-help').removeClass('show').addClass('hidden');
        } else {

          $parent.removeClass('has-success').addClass('has-error has-feedback');
          $parent.find('.success-icon').removeClass('show').addClass('hidden');
          $parent.find('.fail-icon').removeClass('hidden').addClass('show');
          $parent.find('.fail-help').removeClass('hidden').addClass('show');
        }
      };

      $('#session, #participation-code').on('blur', validateSessionInput);

      //Copied from trusted/session_data
      var getParameterByName = function (name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
          results = regex.exec(location.search);
        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      };

      $participationCode.val(getParameterByName('participationCode'));
      $session.val(getParameterByName('session'));

      var req = $.ajax({
        type: "GET",
        url: "../shared/templates/tables.json",
        dataType: "json"
      }).then(function (tables_def) {
        // Create the tables
        var tables = make_tables(tables_def);
        window.scrollTo(0, 0);
        var sums = [0, 0]; // Internal total of Non NaNs values.
        var NaNs = [0, 0]; // Counts how many NaNs exist for every cell participating in a total.

        // Custom afterChange hook that computes the totals
        var afterChange = function (changes, source) {
          if (changes == null) return;

          for (var i = 0; i < changes.length; i++) {
            var change = changes[i];
            var old = change[2];
            var val = change[3];

            var c = change[1];
            var index = c % 2; // Even columns are for females, odd are for males.

            if (old === undefined) old = null;
            if (val === undefined) val = null;

            // Keep track of how many NaNs there are.
            if (isNaN(old) && !isNaN(val)) NaNs[index]--;
            if (!isNaN(old) && isNaN(val)) NaNs[index]++;

            // If either values is a NaN, discard it when computing internal sum.
            old = (old == '' || old == null || isNaN(old)) ? 0 : old;
            val = (val == '' || val == null || isNaN(val)) ? 0 : val;
            sums[index] += val - old;
          }

          // Display a NaN in the totals Column if you need too.
          var totals = [sums[0], sums[1], sums[0] + sums[1]];
          if (NaNs[0] + NaNs[1] > 0) { // If there is at least one NaN, change every thing to Excel's NaN equivalent.
            totals = ["#VALUE!", "#VALUE!", "#VALUE!"];
          }
          tables[4].loadData([totals]);
        };

        // Custom validator that checks for semantic discrepancies across many tables. In particular:
        // 1. For all tables except bonus (3rd table), the cell must be either zero in all tables, or non-zero in all tables.
        // 2. For the bonus table (3rd table), it can only be non-zero if the other tables are non-zero.
        var discrepancies_validator = function (table, cell, value, callback) {
          var bonus_table = tables[2];
          var name = table._sail_meta.name;
          var r = cell.row_index;
          var c = cell.col_index;

          // bonus can only be non-zero if the other tables are non-zero.
          if (name == bonus_table._sail_meta.name) {
            // bonus can only be non-zero if the other tables are non-zero.
            if (value > 0) {
              for (var i = 0; i < tables.length - 1; i++) { // length-1 because of the totals table
                if (i == 2) continue;

                if (!(tables[i].getDataAtCell(r, c) > 0)) {
                  console.log("Semantic error in '" + table._sail_meta.name + "' at (" + r + ", " + c + ")");
                  // callback(false); // No need to invalidate other cells here.
                }
              }
            }
          }

          // Not bonus table
          else {
            // the cell must be either zero in all tables, or non-zero in all tables
            var compare = value > 0;
            var error = false;
            for (var i = 0; i < tables.length - 1; i++) { // length-1 because of the totals table
              if (i == 2 || name == tables[i]._sail_meta.name) continue;

              if ((tables[i].getDataAtCell(r, c) > 0) !== compare) {
                console.log("Semantic error in '" + table._sail_meta.name + "' at (" + r + ", " + c + ")");
                error = true;
                // callback(false);
              }
            }
          }

          // find a way to validate/invalidate the other cells to also have the same error.
          // probably should use _sail_meta of the other tables to store if their is an error
          // and render it using custom renderer. Calling the validators of other cells will
          // cause an infinite loop unless something smart was done about it.

          // Validate the other cells so that if this update resolves their issue, they will be notified.
          callback(true);
        };

        register_validator("discrepancies", discrepancies_validator);

        // Alerts, page elements, etc. for drag-and-drop/choose file.
        var workbook_js = null;

        var _target = document.getElementById('drop-area');
        var _choose = document.getElementById('choose-file-button');
        var spinner;
        var _workstart = function () {
          if ($('#tables-area').css('display') !== 'none') {
            $('#tables-area').hide();
          }
          spinner = new Spinner().spin(_target);
        };
        var _workend = function () {
          spinner.stop();
          $('#tables-area').slideToggle();
        };
        var _badfile = function () {
          alertify.alert("<img src='style/cancel.png' alt='Error'>Error!", 'This file does not appear to be a valid Excel file.', function () {
          });
        };
        var _pending = function () {
          alertify.alert("<img src='style/cancel.png' alt='Error'>Error!", 'Please wait until the current file is processed.', function () {
          });
        };
        var _large = function (len, cb) {
          alertify.confirm("<img src='style/cancel.png' alt='Error'>Error!", "This file is " + (len / (1024 * 1024)).toFixed(2) + " MB and may take a few moments. Your browser may lock up during this process. Continue?", cb);
        };
        var _failed = function (e) {
          alertify.alert("<img src='style/cancel.png' alt='Error'>Error!", 'This format is not supported.', function () {
          });
        };

        var $window, availableWidth, availableHeight;
        var calculateSize = function () {
          availableWidth = Math.max($('#drop-area').width(), 600);
          availableHeight = Math.max($window.height() - 250, 400);
        };
        $(document).ready(function () {
          $window = $(window);
          $window.on('resize', calculateSize);
        });


        var _onsheet = function (json, cols, sheetnames, select_sheet_cb) {
          calculateSize();
          if (!json) json = [];
          /* add header row for table */
          json.unshift(function (head) {
            var o = {};
            for (i = 0; i != head.length; ++i) o[head[i]] = head[i];
            return o;
          }(cols));
          calculateSize();
        };


        DropSheet({
          drop: _target,
          choose: _choose,
          tables: tables,
          tables_def: tables_def,
          on: {workstart: _workstart, workend: _workend, sheet: _onsheet},
          errors: {badfile: _badfile, pending: _pending, failed: _failed, large: _large}
        });


        // Table accordion.
        $('#tables-area').hide();

        $('#expand-table-button').click(function (e) {
          $('#tables-area').slideToggle();
          $(e.target).toggleClass('flip');
        });


        // Register when ready
        tables[0].addHook('afterChange', afterChange);

        // Button clicks handlers
        $('#verify').click(function () {
          validate(tables, function (result, msg) {
            $('.errors').empty();
            if (result) {
              return $("#submit").prop('disabled', false);
            }
            for (var i = 0; i < msg.length; i++) {
              $('.errors').append('<li>' + msg[i] + '</li>');
              //error(msg);
            }
            $('#verify').prop('checked', false);
          });
        });

        $("#submit").click(function () {
          var la = Ladda.create(document.getElementById('submit'));
          validate(tables, function (result, msg) {
            $('.errors').empty();
            if (!result) {
              la.stop();
              for (var i = 0; i < msg.length; i++) {
                $('.errors').append('<li><p>' + msg[i] + '</p></li>');
              }
              return;
            }

            construct_and_send(tables, la);
          });
        });

      });
    });
  </script>
</main>
</body>
</html>
