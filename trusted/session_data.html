<html>
<head>
  <title>Trusted Party Live Session Tracker</title>

  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"
          integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"
          integrity="sha256-obZACiHd7gkOk9iIL/pimWMTJ4W/pBsKu+oZnSeBIek=" crossorigin="anonymous"></script>
  <script type="text/javascript" src="script/generateSession.js"></script>
  <link rel="stylesheet" type="text/css" href="style/bootstrap/css/bootstrap.css">
  <style>
    #hidden-content {
      visibility: hidden;
    }

    #urlsID {
      visibility: hidden;
    }

    #confirmation {
      visibility: hidden;
    }

    input[type=text] {
      height: 30px;
      width: 300px;
    }

    input[type=password] {
      height: 30px;
      width: 300px;
    }

    .modal {
      visibility: hidden;
      padding: 30px;
      text-align: center;
      background-color: #AAAAAA;
    }

    .modal input {
      margin-bottom: 10px;
    }

    #modal_error_msg {
      color: #FF0000;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="page-header">
    <table width="100%">
      <tr>
        <td>
          <h1>Trusted Party<br/>
            <small>Live Session Tracker</small>
          </h1>
        </td>
        <td align="right">
          <img src="../shared/bu.png" width="110px"/>
        </td>
      </tr>
    </table>
  </div>
  <form class="form-inline" role="form" id="inputform">
    <input type="text" id="sess" placeholder="Session Number"/>
    <input type="password" id="pass" placeholder="Session Password"/>
    <button id="submit" type="button" class="btn btn-primary" onclick="genT()">SUBMIT</button>
  </form>

  <div id="hidden-content">
    <div class="alert alert-success" id="statusID">LOADING...</div>
    <div>
      <h3>Control Panel</h3>
      <input id="statusbox" type="text" placeholder="Session Status:" disabled><br>
      <input type="button" class="btn btn-primary" id="start" value="START">
      <input type="button" class="btn btn-primary" id="pause" value="PAUSE">
      <input type="button" class="btn btn-primary" id="stop" value="STOP">
    </div>

    <div id="confirmation" class="modal">
      <h3>Please confirm Session termination</h3>
      <form class="form-inline" role="form" id="confirmationform">
        <input type="text" id="sess_s" placeholder="Session Number"/> <br/>
        <input type="password" id="pass_s" placeholder="Session Password"/> <br/>
        <button id="confirm" type="button" class="btn btn-primary">SUBMIT</button>
        <button id="cancel" type="button" class="btn btn-primary">CANCEL</button>
        <br/>
        <h4 id="modal_error_msg"></h4>
      </form>
    </div>

    <h3>Tracking and Unmasking</h3>
    <div><a id="unmasklink"></a></div>
    <table class="table table-striped" id="table">
      <thead>
      <tr>
        <th>Email</th>
        <th>Posted</th>
      </tr>
      </thead>
      <tbody id="participants">
      </tbody>
    </table>
    <br/>
    <div id="urlsSection">
      <h3>Links for Participants </h3>
      <form class="form-inline" role="form">
        <input autocomplete="off" type="text" id="countID" placeholder="Enter Number of new links needed"
               pattern="^[0-9]{1,5}$" size="5" required>
        <button id="gen_button" type="button" class="btn">
          Generate Links
        </button>
      </form>
      <pre id="urlsID"></pre>

      <div id="oldUrlsSection">
        <h3>Previously Generated Links</h3>
        <pre id="oldUrlsID"></pre>
      </div>
    </div>
  </div>
  <script>
    window.getParameterByName = function (name) {
      name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
      var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
      return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    };
    if (getParameterByName('session')) {
      var session = getParameterByName('session');
      document.getElementById("sess").value = session;
    }
    window.genT = function () {
      document.getElementById('hidden-content').style.visibility = "visible";

      var session = document.getElementById('sess').value;
      var password = document.getElementById('pass').value;
      var start = document.getElementById('start').value;
      var pause = document.getElementById('pause').value;
      var stop = document.getElementById('stop').value;
      $('#inputform').remove();

      document.getElementById('unmasklink').innerHTML = "Click here to unmask aggregate data Session " + session;
      document.getElementById('unmasklink').href = "../unmask/index.html?session=" + session;

      checkStatus(session);
      generateTable('table', session, password, 'statusID');

      fetchOldLinks(session, password, "oldUrlsID", "oldUrlsSection");
      document.getElementById("gen_button").onclick = function () {
        var count = document.getElementById("countID").value;
        count = parseInt(count);

        if(isNaN(count)) { // fail gracefully
          alert("Please enter the number of desired links");
          return;
        }

        generateUrls(session, password, 'urlsID', count);
      };

      document.getElementById("start").onclick = function () {
        changeStatus(session, start, password)
      };
      document.getElementById("pause").onclick = function () {
        changeStatus(session, pause, password)
      };
      document.getElementById("stop").onclick = function () {
        document.getElementById('statusbox').value = checkStatus(session);
        document.getElementById('modal_error_msg').innerHTML = "";
        document.getElementById('confirmation').style.visibility = "visible";

        document.getElementById("cancel").onclick = function () {
          document.getElementById('confirmation').style.visibility = "hidden";
        };

        document.getElementById("confirm").onclick = function () {
          var modal_session = document.getElementById('sess_s').value;
          var modal_password = document.getElementById('pass_s').value;
          if (modal_session === session && modal_password === password) {
            document.getElementById('confirmation').style.visibility = "hidden";
            changeStatus(session, stop, password);
          } else {
            document.getElementById('modal_error_msg').innerHTML = "Session and Password do not match!";
          }
        };
      };
    };

    window.getParameterByName = function (name) {
      name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
      var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
      return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    };

    if (getParameterByName('session')) {
      var session = getParameterByName('session');
      document.getElementById("sess").value = session;
    }
  </script>
</div>
</body>
</html>
